package webhook

import (
	"bytes"
	"net/http"
	"os"
	"testing"

	"github.com/stretchr/testify/assert"
)

var githubPushBody = []byte(`{"ref":"refs/heads/master","before":"0000000000000000000000000000000000000000","after":"f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa","created":true,"deleted":false,"forced":false,"base_ref":"refs/heads/master","compare":"https://github.com/brian-nguyen/inertia-deploy-test/compare/master","commits":[],"head_commit":{"id":"f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa","tree_id":"093ac15ad7a9b8df5deb553b026f430bc8b5b52d","distinct":true,"message":"Local parse test","timestamp":"2018-07-07T13:56:43-07:00","url":"https://github.com/brian-nguyen/inertia-deploy-test/commit/f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa","author":{"name":"brian-nguyen","email":"briannguyen992@gmail.com","username":"brian-nguyen"},"committer":{"name":"brian-nguyen","email":"briannguyen992@gmail.com","username":"brian-nguyen"},"added":[],"removed":[],"modified":["README.md"]},"repository":{"id":133707414,"node_id":"MDEwOlJlcG9zaXRvcnkxMzM3MDc0MTQ=","name":"inertia-deploy-test","full_name":"brian-nguyen/inertia-deploy-test","owner":{"name":"brian-nguyen","email":"briannguyen992@gmail.com","login":"brian-nguyen","id":11564004,"node_id":"MDQ6VXNlcjExNTY0MDA0","avatar_url":"https://avatars3.githubusercontent.com/u/11564004?v=4","gravatar_id":"","url":"https://api.github.com/users/brian-nguyen","html_url":"https://github.com/brian-nguyen","followers_url":"https://api.github.com/users/brian-nguyen/followers","following_url":"https://api.github.com/users/brian-nguyen/following{/other_user}","gists_url":"https://api.github.com/users/brian-nguyen/gists{/gist_id}","starred_url":"https://api.github.com/users/brian-nguyen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brian-nguyen/subscriptions","organizations_url":"https://api.github.com/users/brian-nguyen/orgs","repos_url":"https://api.github.com/users/brian-nguyen/repos","events_url":"https://api.github.com/users/brian-nguyen/events{/privacy}","received_events_url":"https://api.github.com/users/brian-nguyen/received_events","type":"User","site_admin":false},"private":false,"html_url":"https://github.com/brian-nguyen/inertia-deploy-test","description":":warning: a repository for testing Inertia deployments","fork":true,"url":"https://github.com/brian-nguyen/inertia-deploy-test","forks_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/forks","keys_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/keys{/key_id}","collaborators_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/teams","hooks_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/hooks","issue_events_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/issues/events{/number}","events_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/events","assignees_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/assignees{/user}","branches_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/branches{/branch}","tags_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/tags","blobs_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/git/refs{/sha}","trees_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/git/trees{/sha}","statuses_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/statuses/{sha}","languages_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/languages","stargazers_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/stargazers","contributors_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/contributors","subscribers_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/subscribers","subscription_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/subscription","commits_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/commits{/sha}","git_commits_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/git/commits{/sha}","comments_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/comments{/number}","issue_comment_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/issues/comments{/number}","contents_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/contents/{+path}","compare_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/compare/{base}...{head}","merges_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/merges","archive_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/downloads","issues_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/issues{/number}","pulls_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/pulls{/number}","milestones_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/milestones{/number}","notifications_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/labels{/name}","releases_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/releases{/id}","deployments_url":"https://api.github.com/repos/brian-nguyen/inertia-deploy-test/deployments","created_at":1526495113,"updated_at":"2018-07-07T20:56:52Z","pushed_at":1532154928,"git_url":"git://github.com/brian-nguyen/inertia-deploy-test.git","ssh_url":"git@github.com:brian-nguyen/inertia-deploy-test.git","clone_url":"https://github.com/brian-nguyen/inertia-deploy-test.git","svn_url":"https://github.com/brian-nguyen/inertia-deploy-test","homepage":"https://github.com/ubclaunchpad/inertia","size":5,"stargazers_count":0,"watchers_count":0,"language":"Python","has_issues":false,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"forks_count":0,"mirror_url":null,"archived":false,"open_issues_count":0,"license":null,"forks":0,"open_issues":0,"watchers":0,"default_branch":"master","stargazers":0,"master_branch":"master"},"pusher":{"name":"brian-nguyen","email":"briannguyen992@gmail.com"},"sender":{"login":"brian-nguyen","id":11564004,"node_id":"MDQ6VXNlcjExNTY0MDA0","avatar_url":"https://avatars3.githubusercontent.com/u/11564004?v=4","gravatar_id":"","url":"https://api.github.com/users/brian-nguyen","html_url":"https://github.com/brian-nguyen","followers_url":"https://api.github.com/users/brian-nguyen/followers","following_url":"https://api.github.com/users/brian-nguyen/following{/other_user}","gists_url":"https://api.github.com/users/brian-nguyen/gists{/gist_id}","starred_url":"https://api.github.com/users/brian-nguyen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brian-nguyen/subscriptions","organizations_url":"https://api.github.com/users/brian-nguyen/orgs","repos_url":"https://api.github.com/users/brian-nguyen/repos","events_url":"https://api.github.com/users/brian-nguyen/events{/privacy}","received_events_url":"https://api.github.com/users/brian-nguyen/received_events","type":"User","site_admin":false}}`)
var gitlabPushBody = []byte(`{"object_kind":"push","event_name":"push","before":"782fc00feb08df381c7a7d94f52d32cf46fb4065","after":"f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa","ref":"refs/heads/master","checkout_sha":"f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa","message":null,"user_id":2170981,"user_name":"Brian Nguyen","user_username":"brian-nguyen","user_email":"briannguyen992@gmail.com","user_avatar":"https://secure.gravatar.com/avatar/c9054894165564c14023316f304e7297?s=80\u0026d=identicon","project_id":7392827,"project":{"id":7392827,"name":"inertia-deploy-test","description":"","web_url":"https://gitlab.com/brian-nguyen/inertia-deploy-test","avatar_url":null,"git_ssh_url":"git@gitlab.com:brian-nguyen/inertia-deploy-test.git","git_http_url":"https://gitlab.com/brian-nguyen/inertia-deploy-test.git","namespace":"brian-nguyen","visibility_level":20,"path_with_namespace":"brian-nguyen/inertia-deploy-test","default_branch":"master","ci_config_path":null,"homepage":"https://gitlab.com/brian-nguyen/inertia-deploy-test","url":"git@gitlab.com:brian-nguyen/inertia-deploy-test.git","ssh_url":"git@gitlab.com:brian-nguyen/inertia-deploy-test.git","http_url":"https://gitlab.com/brian-nguyen/inertia-deploy-test.git"},"commits":[{"id":"f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa","message":"Local parse test\n","timestamp":"2018-07-07T20:56:43Z","url":"https://gitlab.com/brian-nguyen/inertia-deploy-test/commit/f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa","author":{"name":"brian-nguyen","email":"briannguyen992@gmail.com"},"added":[],"modified":["README.md"],"removed":[]},{"id":"a29ac9c00794f1325182d6afdbafad2558b64c85","message":"Github remote test\n","timestamp":"2018-07-07T06:16:38Z","url":"https://gitlab.com/brian-nguyen/inertia-deploy-test/commit/a29ac9c00794f1325182d6afdbafad2558b64c85","author":{"name":"brian-nguyen","email":"briannguyen992@gmail.com"},"added":[],"modified":["README.md"],"removed":[]},{"id":"782fc00feb08df381c7a7d94f52d32cf46fb4065","message":"Enforce JSON for Github\n","timestamp":"2018-07-07T06:15:45Z","url":"https://gitlab.com/brian-nguyen/inertia-deploy-test/commit/782fc00feb08df381c7a7d94f52d32cf46fb4065","author":{"name":"brian-nguyen","email":"briannguyen992@gmail.com"},"added":[],"modified":["README.md"],"removed":[]}],"total_commits_count":3,"repository":{"name":"inertia-deploy-test","url":"git@gitlab.com:brian-nguyen/inertia-deploy-test.git","description":"","homepage":"https://gitlab.com/brian-nguyen/inertia-deploy-test","git_http_url":"https://gitlab.com/brian-nguyen/inertia-deploy-test.git","git_ssh_url":"git@gitlab.com:brian-nguyen/inertia-deploy-test.git","visibility_level":20}}`)
var bitbucketPushBody = []byte(`{"push": {"changes": [{"forced": false, "old": {"type": "branch", "name": "master", "links": {"commits": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commits/master"}, "self": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/refs/branches/master"}, "html": {"href": "https://bitbucket.org/brian-nguyen/inertia-deploy-test/branch/master"}}, "target": {"hash": "88d0d4becc199c8c2005faebca0fe3c446c88f50", "links": {"self": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/88d0d4becc199c8c2005faebca0fe3c446c88f50"}, "html": {"href": "https://bitbucket.org/brian-nguyen/inertia-deploy-test/commits/88d0d4becc199c8c2005faebca0fe3c446c88f50"}}, "author": {"raw": "brian-nguyen <briannguyen992@gmail.com>", "type": "author", "user": {"username": "brian-nguyen", "display_name": "Brian Nguyen", "account_id": "557058:e73ba7e8-353b-4015-b7cd-77828b57dcad", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/brian-nguyen"}, "html": {"href": "https://bitbucket.org/brian-nguyen/"}, "avatar": {"href": "https://bitbucket.org/account/brian-nguyen/avatar/"}}, "type": "user", "uuid": "{0d8c0652-f421-44cc-a58b-2f1c8c09fe9f}"}}, "summary": {"raw": "Local github test\n", "markup": "markdown", "html": "<p>Local github test</p>", "type": "rendered"}, "parents": [{"type": "commit", "hash": "082d134b0f50a4a4fac3ce73292b68697decd97e", "links": {"self": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/082d134b0f50a4a4fac3ce73292b68697decd97e"}, "html": {"href": "https://bitbucket.org/brian-nguyen/inertia-deploy-test/commits/082d134b0f50a4a4fac3ce73292b68697decd97e"}}}], "date": "2018-07-07T06:03:34+00:00", "message": "Local github test\n", "type": "commit"}}, "links": {"commits": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commits?include=f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa&exclude=88d0d4becc199c8c2005faebca0fe3c446c88f50"}, "html": {"href": "https://bitbucket.org/brian-nguyen/inertia-deploy-test/branches/compare/f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa..88d0d4becc199c8c2005faebca0fe3c446c88f50"}, "diff": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/diff/f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa..88d0d4becc199c8c2005faebca0fe3c446c88f50"}}, "truncated": false, "commits": [{"hash": "f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa", "links": {"self": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa"}, "comments": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa/comments"}, "patch": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/patch/f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa"}, "html": {"href": "https://bitbucket.org/brian-nguyen/inertia-deploy-test/commits/f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa"}, "diff": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/diff/f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa"}, "approve": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa/approve"}, "statuses": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa/statuses"}}, "author": {"raw": "brian-nguyen <briannguyen992@gmail.com>", "type": "author", "user": {"username": "brian-nguyen", "display_name": "Brian Nguyen", "account_id": "557058:e73ba7e8-353b-4015-b7cd-77828b57dcad", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/brian-nguyen"}, "html": {"href": "https://bitbucket.org/brian-nguyen/"}, "avatar": {"href": "https://bitbucket.org/account/brian-nguyen/avatar/"}}, "type": "user", "uuid": "{0d8c0652-f421-44cc-a58b-2f1c8c09fe9f}"}}, "summary": {"raw": "Local parse test\n", "markup": "markdown", "html": "<p>Local parse test</p>", "type": "rendered"}, "parents": [{"type": "commit", "hash": "a29ac9c00794f1325182d6afdbafad2558b64c85", "links": {"self": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/a29ac9c00794f1325182d6afdbafad2558b64c85"}, "html": {"href": "https://bitbucket.org/brian-nguyen/inertia-deploy-test/commits/a29ac9c00794f1325182d6afdbafad2558b64c85"}}}], "date": "2018-07-07T20:56:43+00:00", "message": "Local parse test\n", "type": "commit"}, {"hash": "a29ac9c00794f1325182d6afdbafad2558b64c85", "links": {"self": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/a29ac9c00794f1325182d6afdbafad2558b64c85"}, "comments": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/a29ac9c00794f1325182d6afdbafad2558b64c85/comments"}, "patch": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/patch/a29ac9c00794f1325182d6afdbafad2558b64c85"}, "html": {"href": "https://bitbucket.org/brian-nguyen/inertia-deploy-test/commits/a29ac9c00794f1325182d6afdbafad2558b64c85"}, "diff": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/diff/a29ac9c00794f1325182d6afdbafad2558b64c85"}, "approve": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/a29ac9c00794f1325182d6afdbafad2558b64c85/approve"}, "statuses": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/a29ac9c00794f1325182d6afdbafad2558b64c85/statuses"}}, "author": {"raw": "brian-nguyen <briannguyen992@gmail.com>", "type": "author", "user": {"username": "brian-nguyen", "display_name": "Brian Nguyen", "account_id": "557058:e73ba7e8-353b-4015-b7cd-77828b57dcad", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/brian-nguyen"}, "html": {"href": "https://bitbucket.org/brian-nguyen/"}, "avatar": {"href": "https://bitbucket.org/account/brian-nguyen/avatar/"}}, "type": "user", "uuid": "{0d8c0652-f421-44cc-a58b-2f1c8c09fe9f}"}}, "summary": {"raw": "Github remote test\n", "markup": "markdown", "html": "<p>Github remote test</p>", "type": "rendered"}, "parents": [{"type": "commit", "hash": "782fc00feb08df381c7a7d94f52d32cf46fb4065", "links": {"self": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/782fc00feb08df381c7a7d94f52d32cf46fb4065"}, "html": {"href": "https://bitbucket.org/brian-nguyen/inertia-deploy-test/commits/782fc00feb08df381c7a7d94f52d32cf46fb4065"}}}], "date": "2018-07-07T06:16:38+00:00", "message": "Github remote test\n", "type": "commit"}, {"hash": "782fc00feb08df381c7a7d94f52d32cf46fb4065", "links": {"self": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/782fc00feb08df381c7a7d94f52d32cf46fb4065"}, "comments": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/782fc00feb08df381c7a7d94f52d32cf46fb4065/comments"}, "patch": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/patch/782fc00feb08df381c7a7d94f52d32cf46fb4065"}, "html": {"href": "https://bitbucket.org/brian-nguyen/inertia-deploy-test/commits/782fc00feb08df381c7a7d94f52d32cf46fb4065"}, "diff": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/diff/782fc00feb08df381c7a7d94f52d32cf46fb4065"}, "approve": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/782fc00feb08df381c7a7d94f52d32cf46fb4065/approve"}, "statuses": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/782fc00feb08df381c7a7d94f52d32cf46fb4065/statuses"}}, "author": {"raw": "brian-nguyen <briannguyen992@gmail.com>", "type": "author", "user": {"username": "brian-nguyen", "display_name": "Brian Nguyen", "account_id": "557058:e73ba7e8-353b-4015-b7cd-77828b57dcad", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/brian-nguyen"}, "html": {"href": "https://bitbucket.org/brian-nguyen/"}, "avatar": {"href": "https://bitbucket.org/account/brian-nguyen/avatar/"}}, "type": "user", "uuid": "{0d8c0652-f421-44cc-a58b-2f1c8c09fe9f}"}}, "summary": {"raw": "Enforce JSON for Github\n", "markup": "markdown", "html": "<p>Enforce JSON for Github</p>", "type": "rendered"}, "parents": [{"type": "commit", "hash": "88d0d4becc199c8c2005faebca0fe3c446c88f50", "links": {"self": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/88d0d4becc199c8c2005faebca0fe3c446c88f50"}, "html": {"href": "https://bitbucket.org/brian-nguyen/inertia-deploy-test/commits/88d0d4becc199c8c2005faebca0fe3c446c88f50"}}}], "date": "2018-07-07T06:15:45+00:00", "message": "Enforce JSON for Github\n", "type": "commit"}], "created": false, "closed": false, "new": {"type": "branch", "name": "master", "links": {"commits": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commits/master"}, "self": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/refs/branches/master"}, "html": {"href": "https://bitbucket.org/brian-nguyen/inertia-deploy-test/branch/master"}}, "target": {"hash": "f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa", "links": {"self": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa"}, "html": {"href": "https://bitbucket.org/brian-nguyen/inertia-deploy-test/commits/f7da6e2506829ef3ee8e3f1a2bfae534a5ab5dfa"}}, "author": {"raw": "brian-nguyen <briannguyen992@gmail.com>", "type": "author", "user": {"username": "brian-nguyen", "display_name": "Brian Nguyen", "account_id": "557058:e73ba7e8-353b-4015-b7cd-77828b57dcad", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/brian-nguyen"}, "html": {"href": "https://bitbucket.org/brian-nguyen/"}, "avatar": {"href": "https://bitbucket.org/account/brian-nguyen/avatar/"}}, "type": "user", "uuid": "{0d8c0652-f421-44cc-a58b-2f1c8c09fe9f}"}}, "summary": {"raw": "Local parse test\n", "markup": "markdown", "html": "<p>Local parse test</p>", "type": "rendered"}, "parents": [{"type": "commit", "hash": "a29ac9c00794f1325182d6afdbafad2558b64c85", "links": {"self": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test/commit/a29ac9c00794f1325182d6afdbafad2558b64c85"}, "html": {"href": "https://bitbucket.org/brian-nguyen/inertia-deploy-test/commits/a29ac9c00794f1325182d6afdbafad2558b64c85"}}}], "date": "2018-07-07T20:56:43+00:00", "message": "Local parse test\n", "type": "commit"}}}]}, "repository": {"scm": "git", "website": "", "name": "inertia-deploy-test", "links": {"self": {"href": "https://api.bitbucket.org/2.0/repositories/brian-nguyen/inertia-deploy-test"}, "html": {"href": "https://bitbucket.org/brian-nguyen/inertia-deploy-test"}, "avatar": {"href": "https://bytebucket.org/ravatar/%7Be49b6fff-e6cd-4d32-bd4d-cda24f99384b%7D?ts=default"}}, "full_name": "brian-nguyen/inertia-deploy-test", "owner": {"username": "brian-nguyen", "display_name": "Brian Nguyen", "account_id": "557058:e73ba7e8-353b-4015-b7cd-77828b57dcad", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/brian-nguyen"}, "html": {"href": "https://bitbucket.org/brian-nguyen/"}, "avatar": {"href": "https://bitbucket.org/account/brian-nguyen/avatar/"}}, "type": "user", "uuid": "{0d8c0652-f421-44cc-a58b-2f1c8c09fe9f}"}, "type": "repository", "is_private": false, "uuid": "{e49b6fff-e6cd-4d32-bd4d-cda24f99384b}"}, "actor": {"username": "brian-nguyen", "display_name": "Brian Nguyen", "account_id": "557058:e73ba7e8-353b-4015-b7cd-77828b57dcad", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/brian-nguyen"}, "html": {"href": "https://bitbucket.org/brian-nguyen/"}, "avatar": {"href": "https://bitbucket.org/account/brian-nguyen/avatar/"}}, "type": "user", "uuid": "{0d8c0652-f421-44cc-a58b-2f1c8c09fe9f}"}}`)

func getMockRequest(rawBody []byte) *http.Request {
	req, _ := http.NewRequest("POST", "/webhook", bytes.NewBuffer(rawBody))
	req.Header.Add("Content-Type", "application/json")
	return req
}
func TestParse(t *testing.T) {
	testCases := []struct {
		reqBody     []byte
		eventHeader string
		eventValue  string
	}{
		{githubPushBody, "x-github-event", GithubPushHeader},
		{gitlabPushBody, "x-gitlab-event", GitlabPushHeader},
		{bitbucketPushBody, "x-event-key", BitbucketPushHeader},
	}

	for _, tc := range testCases {
		req := getMockRequest(tc.reqBody)
		req.Header.Add(tc.eventHeader, tc.eventValue)

		// Special case for Bitbucket because Bitbucket
		if tc.eventHeader == "x-event-key" {
			req.Header.Add("User-Agent", "Bitbucket")
		}

		payload, err := Parse(req, os.Stdout)
		assert.Nil(t, err)

		assert.Equal(t, "push", payload.GetEventType())
		assert.Equal(t, "inertia-deploy-test", payload.GetRepoName())
		assert.Equal(t, "refs/heads/master", payload.GetRef())
	}
}

func TestParseDocker(t *testing.T) {
	assert.Nil(t, nil)
}
